name: NSIS Test Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to build installer for (e.g., v1.4.2)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build-nsis-installer:
    name: Build NSIS Installer
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download release artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ github.event.inputs.version }}"
          Write-Host "Downloading artifacts for version: $version"

          # Download GPU Windows build
          gh release download $version --pattern "birda-windows-x64-cuda-$version.zip"
          if ($LASTEXITCODE -ne 0) {
            throw "gh release download failed with exit code $LASTEXITCODE"
          }

          # Extract to dist directory
          New-Item -ItemType Directory -Force -Path dist
          Expand-Archive -Path "birda-windows-x64-cuda-$version.zip" -DestinationPath "dist" -Force

          Write-Host "Contents of dist/:"
          Get-ChildItem dist -Recurse
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install NSIS
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # NSIS is pre-installed on Windows runners
          # Verify installation
          $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
          if (Test-Path $nsisPath) {
            Write-Host "NSIS found at: $nsisPath"
            & $nsisPath /VERSION
          } else {
            Write-Host "Installing NSIS via chocolatey..."
            choco install nsis -y
          }

      - name: Build NSIS installer
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ github.event.inputs.version }}"
          $versionNumber = $version -replace '^v', ''

          Write-Host "Building NSIS installer for version: $versionNumber"

          # Build with version override
          & "C:\Program Files (x86)\NSIS\makensis.exe" `
            /DPRODUCT_VERSION="$versionNumber" `
            /NOCD `
            "installer\windows\birda.nsi"
          if ($LASTEXITCODE -ne 0) {
            throw "makensis failed with exit code $LASTEXITCODE"
          }

          # Rename output file to include version
          Move-Item "birda-windows-x64-cuda-nsis-setup.exe" `
            "birda-windows-x64-cuda-nsis-$version-setup.exe" `
            -ErrorAction Stop

          Write-Host "Installer created successfully"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v6
        with:
          name: nsis-installer
          path: birda-windows-x64-cuda-nsis-${{ github.event.inputs.version }}-setup.exe

      - name: Create draft release
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $ErrorActionPreference = 'Stop'
          $version = "${{ github.event.inputs.version }}"
          $installerPath = "birda-windows-x64-cuda-nsis-$version-setup.exe"
          $installerSize = (Get-Item $installerPath -ErrorAction Stop).Length / 1MB
          $installerSizeMB = [math]::Round($installerSize, 2)

          # Get Inno Setup installer size for comparison
          gh release download $version --pattern "birda-windows-x64-cuda-$version-setup.exe"
          if ($LASTEXITCODE -ne 0) {
            throw "gh release download failed with exit code $LASTEXITCODE"
          }
          $innoSize = (Get-Item "birda-windows-x64-cuda-$version-setup.exe" -ErrorAction Stop).Length / 1MB
          $innoSizeMB = [math]::Round($innoSize, 2)

          $body = @"
          ## NSIS Test Build for $version

          This is a test build using NSIS installer instead of Inno Setup.

          ### Comparison

          | Metric | NSIS | Inno Setup |
          |--------|------|------------|
          | Installer Size | ${installerSizeMB} MB | ${innoSizeMB} MB |

          ### Testing Checklist

          - [ ] Installation completes without errors
          - [ ] Birda executable works correctly
          - [ ] PATH configuration works (if selected)
          - [ ] VC++ Redistributable installs
          - [ ] Start Menu shortcuts created
          - [ ] Uninstaller removes all files
          - [ ] Uninstaller removes from PATH (if added)
          - [ ] Environment variables updated correctly

          ### Installation

          1. Download `$installerPath`
          2. Run as administrator
          3. Follow installation wizard
          4. Optionally add to PATH

          ### Design Document

          See [docs/nsis-test-installer-design.md](../blob/main/docs/nsis-test-installer-design.md) for full design details.
          "@

          # Create draft release
          gh release create "nsis-test-$version" `
            --draft `
            --title "NSIS Test Build $version" `
            --notes $body `
            $installerPath

          Write-Host "Draft release created: nsis-test-$version"
